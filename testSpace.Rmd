---
title: "TestingSpace"
output: pdf_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r}
 library("tiff")
  library("pracma")
  library("data.table")
  library("functional")
  library("OpenImageR")

  DigitizationTODO <- read.csv("~/Magneto2020/TestTable.csv", header = FALSE)
  names(DigitizationTODO) <- c("ImagePath", "ImageName", "DigitizedYet", "DigitizationPath", "DigitizationName", "ErrorWhenDigitized")
```
  ##Input checking --------------------------------------------------------------------
  #if (is.null(ImageDigitizationDFnx6) | is.null(PWD)) {
   # Error <- "Not all Parameters are filled in, please fill in and try again"
    #return(Error)
  #}
  #if (dim.data.frame(ImageDigitizationDFnx6)[2] != 6) {
   # Error <- "Your dataframe has the wrong dimentions, should be 6 columns with 3rd being TRUE or FALSE"
    #return(Error)
  #}

  ## If all inputs are good, continue

#  output <- c(print(PWD),
#              print(head(ImageDigitizationDFnx6)),
#              print(str(ImageDigitizationDFnx6)))
#return(output)
```{r}
  ## Breaking down the file locations -------------------------------------------------
  for (i in 1:length(DigitizationTODO[,1])) {

    if (DigitizationTODO$DigitizedYet[i] == "True") {
      print(DigitizationTODO$ImageName)

    }
    else if(DigitizationTODO$DigitizedYet[i] == "False"){
      Image.Group <- DigitizationTODO$ImagePath[i]
      print(Image.Group)
    }

    }
  
```

```{r}
for (i in 1:length(DigitizationTODO[,1])) {
if (DigitizationTODO$DigitizedYet[i] == "True") {
      print(paste0(DigitizationTODO$ImageName[i], " has been digitized"))

    }
if(DigitizationTODO$DigitizedYet[i] == "False"){
      Image.Group <- DigitizationTODO$ImagePath[i]
      print(Image.Group,max.levels = 0)
    }

}


```

##for the year checking stuff

 yearChecking <- function(magnetogram){

    splitMag <- strsplit(magnetogram, "-")
    yearMonthDay <- splitMag[[1]][4]
    separating <- strsplit(yearMonthDay,"")
    year <- paste0(separating[[1]][1], separating[[1]][2], separating[[1]][3], separating[[1]][4])
    return(year)
  }

 year <- yearChecking(image_name)

  ## Depending on the year, what to do/ preprocessing -----------------------------------------------------

  if (as.numeric(year) <= 1900 ) {
    if (bright == FALSE) {
      browser()
      mag1[mag1 < (1 - mean(mag1, na.rm = TRUE))] <- 0
      mag1[mag1 > 0] <- 1
      writeTIFF(mag1,"testing3_auto.tif")
    }
  }
  else{}
  
  
  
  
## Start of brightness test ------------------------------------------------------------------------------  
  
```{r}
DigitizationTODO <- read.csv("~/Magneto2020/FinalTable.csv", header = FALSE, stringsAsFactors = FALSE)
names(DigitizationTODO) <- c("ImagePath", "ImageName", "DigitizedYet", "DigitizationPath", "DigitizationName", "ErrorWhenDigitized")

image_import <- function(image,file_loc){
  readTIFF(paste0(file_loc,"/",image))
}
imageChecking <- function(imageName,locationToCheck){
  splitMag <- strsplit(imageName, "-")
  firstThing <- splitMag[[1]][locationToCheck]
  return(firstThing)
}
isTiff <- function(imageName){
  splitMag <- strsplit(imageName, "-")
  lastStringInSplit <- strsplit(last(splitMag[[1]]), "")
  lastLetter <- last(lastStringInSplit[[1]])
  if (lastLetter == "f") {
    return(TRUE)
  }
  else{
    return(FALSE)
  }
}


i = 1
vec <- vector()
counter <- 0
sam <- sample(1:39266, size = 1000,replace = FALSE)
for (i in sam) {
  counter <- counter + 1
  imageName <-  as.character(DigitizationTODO$ImageName[i])
  filePath <- DigitizationTODO$ImagePath[i]
  firstPartOfName <- imageChecking(imageName, 1)
  tiffBool <- isTiff(imageName)

  if (firstPartOfName == "AGC") {
    if (tiffBool == TRUE) { # means that it is a .tiff file
      mag <- image_import(imageName,filePath)
      vec[counter] <- mean(mag)
     
    }
    else {
      DigitizationTODO$ErrorWhenDigitized[i] <- "Not a tiff"
      DigitizationTODO$DigitizedYet[i] <- "Not tiff"
      vec[counter] <- 0

    }
  }
  else{
    DigitizationTODO$ErrorWhenDigitized[i] <- "Not An Image"
    vec[counter] <- 0


  }
}
```

```{r}
for (i in 1:1000){
  if(vec[i] < 0.3){
    
    if(vec[i] > 0.15){
      if(vec[i] != 0){ 
        print(c(vec[i],i))
      } 
      else{}
    }
    else{}
  }
  else{}
}

```

  
```{r}
hist(vec, breaks = 100)
mean(vec)
summary(vec)
```
# lower number
```{r}
j <- 193 
mag1193 <- image_import(DigitizationTODO$ImageName[j],DigitizationTODO$ImagePath[j])
source("~/Magneto2020/Scripts/BreakoutOptimization.R")
mag2193 <- t( apply( mag1193, MARGIN = 1, FUN = deconvGauss, sig = 10, kern.trunc = 0.05, nw = 3 ) )


mag1193[mag1193 < (1 - mean(mag1193,na.rm = TRUE))] <- 0
    mag1193[mag1193 > 0] <- 1
vec[193]
mean(mag1193)
mean(mag2193)


```
## if bright is true

```{r}
j <- 193
magb193 <- image_import(DigitizationTODO$ImageName[j],DigitizationTODO$ImagePath[j])
mean(magb193)
magb2193 <- t( apply( magb193, MARGIN = 1, FUN = deconvGauss, sig = 10, kern.trunc = 0.05, nw = 3 ) )

##line 68 in TIS
      magb193 <- 1/magb193
      if(min(magb193) == 1) {
        magb193 <- magb193-1
        magb193 <- magb193/max(magb193)
}
 magb193[magb193<(quantile(magb193,0.90))] <- 0
      magb193[magb193>0] <- 1
      
      magb2193[0:100,] <- mean(magb2193)
      magb2193[(nrow(magb2193)-60):(nrow(magb2193)),] <- mean(magb2193)
      magb2193[magb2193 < 0] <- 0

      #magb2193[magb2193 < 0] <- 0
      mean(magb193)
      mean(magb2193)
      
```


#The ones that are in the main range


```{r}
j <- 27580
mag27580 <- image_import(DigitizationTODO$ImageName[j],DigitizationTODO$ImagePath[j])
source("~/Magneto2020/Scripts/BreakoutOptimization.R")
mean(mag27580)
mag227580 <- t( apply( mag27580, MARGIN = 1, FUN = deconvGauss, sig = 10, kern.trunc = 0.05, nw = 3 ) )


mag27580[mag27580 < (1 - mean(mag27580,na.rm = TRUE))] <- 0
    mag27580[mag27580 > 0] <- 1
    
mean(mag27580)
mean(mag227580)

```
```{r}
j <- 8907
mag8907 <- image_import(DigitizationTODO$ImageName[j],DigitizationTODO$ImagePath[j])
source("~/Magneto2020/Scripts/BreakoutOptimization.R")
mean(mag8907)
mag28907 <- t( apply( mag8907, MARGIN = 1, FUN = deconvGauss, sig = 10, kern.trunc = 0.05, nw = 3 ) )


mag8907[mag8907 < (1 - mean(mag8907,na.rm = TRUE))] <- 0
    mag8907[mag8907 > 0] <- 1
    
mean(mag8907)
mean(mag28907)

```

# higher range

```{r}
j <- 17394
mag17394 <- image_import(DigitizationTODO$ImageName[j],DigitizationTODO$ImagePath[j])
mean(mag17394)
source("~/Magneto2020/Scripts/BreakoutOptimization.R")
mag217394 <- t( apply( mag17394, MARGIN = 1, FUN = deconvGauss, sig = 10, kern.trunc = 0.05, nw = 3 ) )


mag17394[mag17394 < (1 - mean(mag17394,na.rm = TRUE))] <- 0
    mag17394[mag17394 > 0] <- 1
    
mean(mag17394)
mean(mag217394)
```
## Bright is true

```{r}
j <- 17394
magb17394 <- image_import(DigitizationTODO$ImageName[j],DigitizationTODO$ImagePath[j])
mean(magb17394)
magb217394 <- t( apply( magb17394, MARGIN = 1, FUN = deconvGauss, sig = 10, kern.trunc = 0.05, nw = 3 ) )

 magb17394 <- 1/magb17394
 #     if(min(magb17394) == 1) {
  #      magb17394 <- magb17394-1
   #     magb17394 <- magb17394/max(magb17394)
#}
 magb17394[magb17394<(quantile(magb17394,0.90,na.rm = TRUE))] <- 0
      magb17394[magb17394>0] <- 1

      
      magb217394[0:100,] <- mean(magb217394)
      magb217394[(nrow(magb217394)-60):(nrow(magb217394)),] <- mean(magb217394)
      magb217394[magb217394 < 0] <- 0

      #magb217394[magb217394 < 0] <- 0
      mean(magb17394)
      mean(magb217394)
```





#Making a distribution of the means
```{r}
TestData <- DiffWithAndWithoutGauss
```

```{r}
library("ggplot2")
library("data.table")
library("tiff")
length <- length(TestData)
```

```{r}
Gauss <- data.frame(Range = TestData$GaussMatMean)
Mat <- data.frame(Range = TestData$MatMean)

Gauss$mean <- "forGauss"
Mat$mean <- "Image"

Means <- rbind(Gauss, Mat)

ggplot(Means, aes(x = Range, fill = mean)) + geom_density(alpha = 0.2)
```

```{r}
DigitizationTODO <- read.csv("~/Magneto2020/FinalTable.csv", header = FALSE, stringsAsFactors = FALSE)
names(DigitizationTODO) <- c("ImagePath", "ImageName", "DigitizedYet", "DigitizationPath", "DigitizationName", "ErrorWhenDigitized")
```

```{r mm.486-gm0.00353}
noGauss <-  image_import("AGC-HDZ-19430207-19430208.tif","/home/ben/magneto/Images/AGC-D-19420521-19430714/")
mean(noGauss)
source("~/Magneto2020/Scripts/BreakoutOptimization.R")
WithGauss <- t( apply( noGauss, MARGIN = 1, FUN = deconvGauss, sig = 10, kern.trunc = 0.05, nw = 3 ) )
mean(WithGauss)
library("rtiff")
plot(noGauss)
plot(WithGauss)
```

```{r mm.0420-gm0.0061353}
noGauss <-  image_import("AGC-Z-19290121-19290123.tif","/home/ben/magneto/Images/AGC-V-19281231-19320101/")
mean(noGauss)
source("~/Magneto2020/Scripts/BreakoutOptimization.R")
WithGauss <- t( apply( noGauss, MARGIN = 1, FUN = deconvGauss, sig = 10, kern.trunc = 0.05, nw = 3 ) )
mean(WithGauss)
library("rtiff")
plot(noGauss)
plot(WithGauss)
```


```{r mm.0096-gm0.014}
noGauss <-  image_import("AGC-Z-19370416-19370418.tif","/home/ben/magneto/Images/Range/AGC-V-19341231-19371001(some VDH)/")
mean(noGauss)
source("~/Magneto2020/Scripts/BreakoutOptimization.R")
WithGauss <- t( apply( noGauss, MARGIN = 1, FUN = deconvGauss, sig = 10, kern.trunc = 0.05, nw = 3 ) )
mean(WithGauss)
library("rtiff")
plot(noGauss)
plot(WithGauss)
```